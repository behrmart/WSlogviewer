<main class="page">
  <header class="hero">
    <p class="eyebrow">Bernardo's Angular + JSON WSFE/WS AXP Log analysis</p>
    <h1>{{ title }}</h1>
    <p>
      Upload a WS AXP or WSFE Oceana log JSON file, run text filters, and inspect each event in a
      condensed one-line format.
    </p>
  </header>

  <section class="panel upload-panel">
    <h2>1. Upload file</h2>
    <label class="file-picker" for="jsonFileInput">
      <span>Select a WS/WSFE JSON Log file</span>
      <input
        id="jsonFileInput"
        type="file"
        accept=".json,application/json"
        (change)="onFileSelected($event)"
      />
    </label>

    @if (fileName) {
      <p class="status-line">Loaded file: <strong>{{ fileName }}</strong></p>
    }

    @if (parseError) {
      <p class="error-line">{{ parseError }}</p>
    }
  </section>

  @if (isLoaded) {
    <section class="panel summary-panel">
      <div class="summary-item">
        <span class="summary-label">Application</span>
        <strong>{{ applicationName }}</strong>
      </div>
      <div class="summary-item">
        <span class="summary-label">Events in file</span>
        <strong>{{ totalEvents }}</strong>
      </div>
      <div class="summary-item">
        <span class="summary-label">Events displayed</span>
        <strong>{{ filteredEvents.length }}</strong>
      </div>
    </section>

    <section class="panel filters-panel">
      <div class="section-header">
        <h2>2. Analyze with filters</h2>
        <button type="button" class="clear-btn" (click)="clearFilters()">Clear filters</button>
      </div>

      <div class="filters-grid">
        <label class="search-filter">
          <span>Search text</span>
          <input
            type="search"
            [(ngModel)]="searchText"
            (ngModelChange)="onFilterChange()"
            placeholder="Search by id, source, topic, message, and raw JSON text"
          />
        </label>

        <div class="filter-check-group">
          <span>Level</span>
          <div class="filter-check-list">
            @for (level of levelOptions; track level) {
              <label class="check-item">
                <input
                  type="checkbox"
                  [checked]="isFilterOptionSelected('level', level)"
                  (change)="toggleFilterOption('level', level, $event)"
                />
                <span>{{ level }}</span>
              </label>
            }
          </div>
        </div>

        <div class="filter-check-group">
          <span>Application / Channel</span>
          <div class="filter-check-list">
            @for (app of applicationOptions; track app) {
              <label class="check-item">
                <input
                  type="checkbox"
                  [checked]="isFilterOptionSelected('application', app)"
                  (change)="toggleFilterOption('application', app, $event)"
                />
                <span>{{ app }}</span>
              </label>
            }
          </div>
        </div>

        <div class="filter-check-group">
          <span>Context / Topic</span>
          <div class="filter-check-list">
            @for (context of contextOptions; track context) {
              <label class="check-item">
                <input
                  type="checkbox"
                  [checked]="isFilterOptionSelected('context', context)"
                  (change)="toggleFilterOption('context', context, $event)"
                />
                <span>{{ context }}</span>
              </label>
            }
          </div>
        </div>
      </div>
    </section>

    @if (metaEntries.length > 0 || prettyMetaBlocks.length > 0) {
      <section class="panel metadata-panel">
        <h2>3. Metadata</h2>
        @if (prettyMetaBlocks.length > 0) {
          <div class="pretty-meta-grid">
            @for (block of prettyMetaBlocks; track block.key) {
              <article class="pretty-meta-card">
                <div class="pretty-meta-header">
                  <h3>{{ block.title }}</h3>
                  <p>{{ block.subtitle }}</p>
                </div>

                <div class="pretty-facts-grid">
                  @for (fact of block.facts; track fact.label) {
                    <div class="pretty-fact">
                      <span>{{ fact.label }}</span>
                      <strong>{{ fact.value }}</strong>
                    </div>
                  }
                </div>

                @if (block.highlights.length > 0) {
                  <div class="pretty-highlight-list">
                    @for (highlight of block.highlights; track highlight) {
                      <span class="pretty-highlight-item">{{ highlight }}</span>
                    }
                  </div>
                }

                <button
                  type="button"
                  class="json-btn meta-json-btn"
                  (click)="toggleMetaJson('pretty-' + block.key)"
                >
                  {{ isMetaExpanded('pretty-' + block.key) ? 'Hide JSON' : 'View JSON' }}
                </button>
                @if (isMetaExpanded('pretty-' + block.key)) {
                  <pre class="meta-json">{{ getMetaRawJson(block) }}</pre>
                }
              </article>
            }
          </div>
        }

        <div class="metadata-grid">
          @for (entry of metaEntries; track entry.key) {
            <div class="meta-card">
              <span>{{ entry.key }}</span>
              <strong>{{ entry.value }}</strong>
              <button
                type="button"
                class="json-btn meta-json-btn"
                (click)="toggleMetaJson('meta-' + entry.key)"
              >
                {{ isMetaExpanded('meta-' + entry.key) ? 'Hide JSON' : 'View JSON' }}
              </button>
              @if (isMetaExpanded('meta-' + entry.key)) {
                <pre class="meta-json">{{ getMetaRawJson(entry) }}</pre>
              }
            </div>
          }
        </div>
      </section>
    }

    <section class="panel events-panel">
      <div class="section-header">
        <h2>4. Events</h2>
        <span class="events-count">{{ filteredEvents.length }} shown (one line each)</span>
      </div>

      @if (filteredEvents.length === 0) {
        <p class="empty-state">No events match the selected filters.</p>
      } @else {
        <div class="events-scroll">
          <div class="events-list">
            <div class="event-line event-head" aria-hidden="true">
              <span class="cell col-time">Timestamp</span>
              <span class="cell col-level">Level</span>
              <span class="cell col-app">Source</span>
              <span class="cell col-context">Context</span>
              <span class="cell col-message">Event</span>
              <span class="cell col-action">JSON</span>
            </div>

            @for (event of filteredEvents; track event.uid) {
              <article class="event-line" [title]="event.lineTitle">
                <span class="cell col-time">{{ event.timestamp }}</span>
                <span
                  class="cell col-level"
                  [class.level-error]="event.levelTone === 'error'"
                  [class.level-warning]="event.levelTone === 'warning'"
                >
                  {{ event.level }}
                </span>
                <span class="cell col-app">{{ event.application }}</span>
                <span class="cell col-context">{{ event.context }}</span>
                <span class="cell col-message">#{{ event.id }} Â· {{ event.message }}</span>
                <span class="cell col-action">
                  <button type="button" class="json-btn" (click)="toggleEventJson(event.uid)">
                    {{ isEventExpanded(event.uid) ? 'Hide JSON' : 'View JSON' }}
                  </button>
                </span>
              </article>

              @if (isEventExpanded(event.uid)) {
                <div class="event-json">
                  <pre>{{ event.rawJson }}</pre>
                </div>
              }
            }
          </div>
        </div>
      }
    </section>
  }
</main>
